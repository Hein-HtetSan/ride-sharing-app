
# Development Dockerfile for RMI Server with Live Reload
FROM eclipse-temurin:21-jdk-alpine

WORKDIR /app

# Install build tools
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
RUN apk update && apk add --no-cache bash findutils coreutils inotify-tools

# Copy lib and scripts (these rarely change)
COPY lib ./lib
COPY scripts ./scripts

# Make scripts executable
RUN chmod +x ./scripts/*.sh

# Copy source code (this will be mounted as volume for live reload)
COPY src ./src

# Create a development script that recompiles on file changes
RUN echo '#!/bin/bash' > /app/dev-start.sh && \
    echo 'echo "Starting RMI Server in development mode with live reload..."' >> /app/dev-start.sh && \
    echo 'RMI_HOST=${RMI_HOSTNAME:-localhost}' >> /app/dev-start.sh && \
    echo 'echo "RMI Server will bind to: $RMI_HOST"' >> /app/dev-start.sh && \
    echo 'compile_and_run() {' >> /app/dev-start.sh && \
    echo '  echo "Compiling Java sources..."' >> /app/dev-start.sh && \
    echo '  find src -name "*.java" | sort > sources.txt' >> /app/dev-start.sh && \
    echo '  javac -d build -cp "./lib/postgresql-42.7.7.jar:./lib/HikariCP-6.3.1.jar:./lib/slf4j-api-2.0.15.jar:./lib/slf4j-simple-2.0.15.jar" @sources.txt' >> /app/dev-start.sh && \
    echo '  if [ $? -eq 0 ]; then' >> /app/dev-start.sh && \
    echo '    echo "Compilation successful. Starting RMI Server..."' >> /app/dev-start.sh && \
    echo '    java -Djava.rmi.server.hostname=$RMI_HOST -Djava.net.preferIPv4Stack=true -cp "./build:./lib/*" com.rsrmi.ride_sharing_api.rmi.servers.RMIServer &' >> /app/dev-start.sh && \
    echo '    SERVER_PID=$!' >> /app/dev-start.sh && \
    echo '  else' >> /app/dev-start.sh && \
    echo '    echo "Compilation failed!"' >> /app/dev-start.sh && \
    echo '    return 1' >> /app/dev-start.sh && \
    echo '  fi' >> /app/dev-start.sh && \
    echo '}' >> /app/dev-start.sh && \
    echo 'compile_and_run' >> /app/dev-start.sh && \
    echo 'while true; do' >> /app/dev-start.sh && \
    echo '  inotifywait -r -e modify,create,delete src/' >> /app/dev-start.sh && \
    echo '  echo "Source code changed, recompiling..."' >> /app/dev-start.sh && \
    echo '  kill $SERVER_PID 2>/dev/null' >> /app/dev-start.sh && \
    echo '  sleep 2' >> /app/dev-start.sh && \
    echo '  compile_and_run' >> /app/dev-start.sh && \
    echo 'done' >> /app/dev-start.sh && \
    chmod +x /app/dev-start.sh

# Expose RMI port
EXPOSE 1099

# Set JVM options for RMI with dynamic hostname
ENV JAVA_OPTS="-Djava.net.preferIPv4Stack=true"

# Use the development script for live reload
CMD ["./dev-start.sh"]